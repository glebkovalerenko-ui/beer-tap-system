# RPi Controller Internals Documentation

## Overview

–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä RPi —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –ø–∏–≤–Ω–æ–≥–æ –∫—Ä–∞–Ω–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: FlowManager, DatabaseHandler, HardwareHandler –∏ SyncManager.

## 1. –ö–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç FlowManager

–ö–ª–∞—Å—Å `FlowManager` —Ä–µ–∞–ª–∏–∑—É–µ—Ç —è–¥—Ä–æ –∫–æ–Ω–µ—á–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Ä–∞–∑–ª–∏–≤–∞ –ø–∏–≤–∞. –ê–≤—Ç–æ–º–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω–æ–º –º–µ—Ç–æ–¥–µ `process()` —Å –ª–∏–Ω–µ–π–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–µ–π —Å–æ—Å—Ç–æ—è–Ω–∏–π.

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

```mermaid
stateDiagram-v2
    [*] --> IDLE
    IDLE --> AUTH : –ö–∞—Ä—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞
    AUTH --> POURING : –ö–∞—Ä—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞
    AUTH --> IDLE : –ö–∞—Ä—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞
    POURING --> SYNC : –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    POURING --> IDLE : –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    SYNC --> IDLE : –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
    
    state IDLE {
        [*] --> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_NFC
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_NFC --> –ö–∞—Ä—Ç–∞_–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ : is_card_present()
    }
    
    state AUTH {
        [*] --> –ü–æ–ª—É—á–µ–Ω–∏–µ_UID
        –ü–æ–ª—É—á–µ–Ω–∏–µ_UID --> –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è_UID
        –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è_UID --> –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ --> –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞ : check_card_auth() = true
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ --> –û—Ç–∫–ª–æ–Ω–µ–Ω–∞ : check_card_auth() = false
        –û—Ç–∫–ª–æ–Ω–µ–Ω–∞ --> –û–∂–∏–¥–∞–Ω–∏–µ_—É–¥–∞–ª–µ–Ω–∏—è
        –û–∂–∏–¥–∞–Ω–∏–µ_—É–¥–∞–ª–µ–Ω–∏—è --> [*]
    }
    
    state POURING {
        [*] --> –û—Ç–∫—Ä—ã—Ç–∏–µ_–∫–ª–∞–ø–∞–Ω–∞
        –û—Ç–∫—Ä—ã—Ç–∏–µ_–∫–ª–∞–ø–∞–Ω–∞ --> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_–ø–æ—Ç–æ–∫–∞
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_–ø–æ—Ç–æ–∫–∞ --> –ò–∑–º–µ—Ä–µ–Ω–∏–µ_–æ–±—ä–µ–º–∞
        –ò–∑–º–µ—Ä–µ–Ω–∏–µ_–æ–±—ä–µ–º–∞ --> –ü—Ä–æ–≤–µ—Ä–∫–∞_—Ç–∞–π–º–∞—É—Ç–∞
        –ü—Ä–æ–≤–µ—Ä–∫–∞_—Ç–∞–π–º–∞—É—Ç–∞ --> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_–ø–æ—Ç–æ–∫–∞ : –ü–æ—Ç–æ–∫ –µ—Å—Ç—å
        –ü—Ä–æ–≤–µ—Ä–∫–∞_—Ç–∞–π–º–∞—É—Ç–∞ --> –¢–∞–π–º–∞—É—Ç : –ù–µ—Ç –ø–æ—Ç–æ–∫–∞ 15—Å
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_–ø–æ—Ç–æ–∫–∞ --> –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤–∞—Ä–∏–∏ : –ö–∞–∂–¥—ã–µ 3—Å
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤–∞—Ä–∏–∏ --> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥_–ø–æ—Ç–æ–∫–∞ : –ù–µ—Ç –∞–≤–∞—Ä–∏–∏
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–∞–≤–∞—Ä–∏–∏ --> –ê–≤–∞—Ä–∏–π–Ω–∞—è_–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ : –ê–≤–∞—Ä–∏—è detected
        –¢–∞–π–º–∞—É—Ç --> –ó–∞–∫—Ä—ã—Ç–∏–µ_–∫–ª–∞–ø–∞–Ω–∞
        –ê–≤–∞—Ä–∏–π–Ω–∞—è_–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ --> –ó–∞–∫—Ä—ã—Ç–∏–µ_–∫–ª–∞–ø–∞–Ω–∞
        –ó–∞–∫—Ä—ã—Ç–∏–µ_–∫–ª–∞–ø–∞–Ω–∞ --> [*]
    }
    
    state SYNC {
        [*] --> –ü—Ä–æ–≤–µ—Ä–∫–∞_–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ_–æ–±—ä–µ–º–∞
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ_–æ–±—ä–µ–º–∞ --> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ_–¥–∞–Ω–Ω—ã—Ö : –û–±—ä–µ–º > 1–º–ª
        –ü—Ä–æ–≤–µ—Ä–∫–∞_–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ_–æ–±—ä–µ–º–∞ --> –°–±—Ä–æ—Å_—Å—á–µ—Ç—á–∏–∫–∞ : –û–±—ä–µ–º ‚â§ 1–º–ª
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ_–¥–∞–Ω–Ω—ã—Ö --> –°–±—Ä–æ—Å_—Å—á–µ—Ç—á–∏–∫–∞
        –°–±—Ä–æ—Å_—Å—á–µ—Ç—á–∏–∫–∞ --> [*]
    }
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π

#### 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ IDLE (–û–∂–∏–¥–∞–Ω–∏–µ)
```python
if not self.hardware.is_card_present():
    return
```
–°–∏—Å—Ç–µ–º–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –Ω–∞–ª–∏—á–∏–µ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `hardware.is_card_present()`

#### 2. –°–æ—Å—Ç–æ—è–Ω–∏–µ AUTH (–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
```python
card_uid = self.hardware.get_card_uid()
card_uid = card_uid.replace(" ", "").lower()
if not self.sync_manager.check_card_auth(card_uid):
    # –û–∂–∏–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ IDLE
    while self.hardware.is_card_present():
        time.sleep(0.5)
    return
```
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ UID –∫–∞—Ä—Ç—ã —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ backend
- –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ - –æ–∂–∏–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã

#### 3. –°–æ—Å—Ç–æ—è–Ω–∏–µ POURING (–ù–∞–ª–∏–≤)
```python
self.hardware.valve_open()
while self.hardware.is_card_present():
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    if emergency_check_counter >= 6:
        if self.sync_manager.check_emergency_stop():
            break
    
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç–æ–∫–∞ –∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫—É–Ω–¥—ã
    current_volume_ml = int(self.hardware.get_volume_liters() * 1000)
    if current_volume_ml > last_volume_ml:
        total_volume_ml = current_volume_ml
        timeout_counter = 0
    else:
        timeout_counter += 1
    
    # –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ—Ç–æ–∫–∞
    if timeout_counter >= 30:
        break
```
- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–ø–∞–Ω–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç–æ–∫–∞ –∫–∞–∂–¥—ã–µ 500–º—Å
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–º–∞
- –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ—Ç–æ–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã

#### 4. –°–æ—Å—Ç–æ—è–Ω–∏–µ SYNC (–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
```python
if total_volume_ml > 1:  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º 1 –º–ª
    pour_data = {
        "client_tx_id": str(uuid.uuid4()),
        "card_uid": card_uid,
        "tap_id": TAP_ID,
        "start_ts": start_ts,
        "end_ts": end_ts,
        "volume_ml": total_volume_ml,
        "price_cents": int((total_volume_ml / 100.0) * PRICE_PER_100ML_CENTS),
        "price_per_ml_at_pour": float(PRICE_PER_100ML_CENTS / 100.0)
    }
    self.db_handler.add_pour(pour_data)
self.hardware.reset_pulses()
```
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–ª–∏–≤–µ –ø—Ä–∏ –æ–±—ä–µ–º–µ > 1–º–ª
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ `client_tx_id`
- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ `PRICE_PER_100ML_CENTS`
- –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –∏–º–ø—É–ª—å—Å–æ–≤ –¥–∞—Ç—á–∏–∫–∞ –ø–æ—Ç–æ–∫–∞

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ NFC –≤ Admin App

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —Å NFC: Rust (pcsc) -> Event -> Svelte Store

–í Admin App —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç—ã —Å NFC —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª–µ–º:

#### –£—Ä–æ–≤–µ–Ω—å 1: Rust Backend (pcsc)
```rust
// src-tauri/src/nfc_handler.rs
use pcsc::{Context, Card, Error, Protocols, ShareMode};

pub fn get_card_uid_internal(
    context_arc: &Arc<Mutex<Context>>,
    reader_name: &str,
) -> Result<Vec<u8>, Error> {
    let context = context_arc.lock().unwrap();
    let c_reader_name = CString::new(reader_name).unwrap();
    let card = context.connect(&c_reader_name, ShareMode::Shared, Protocols::T0 | Protocols::T1)?;
    const GET_UID_APDU: &[u8] = &[0xFF, 0xCA, 0x00, 0x00, 0x00];
    let mut rapdu_buf = [0; 256];
    let rapdu = card.transmit(GET_UID_APDU, &mut rapdu_buf)?;
    if rapdu.len() < 2 || rapdu[rapdu.len() - 2..] != [0x90, 0x00] {
        return Err(Error::Unexpected);
    }
    Ok(rapdu[..rapdu.len() - 2].to_vec())
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Rust —É—Ä–æ–≤–Ω—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `pcsc` –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ NFC —Ä–∏–¥–µ—Ä—É
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ UID –≤ hex-—Å—Ç—Ä–æ–∫—É
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ PC/SC –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

#### –£—Ä–æ–≤–µ–Ω—å 2: Tauri Event System
```rust
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Rust backend
emit('card-status-changed', {
    uid: hex::encode(uid),
    error: null
});
```

**–ú–µ—Ö–∞–Ω–∏–∑–º —Å–æ–±—ã—Ç–∏–π:**
- –°–æ–±—ã—Ç–∏–µ `card-status-changed` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞—Ä—Ç—ã
- Payload —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏–±–æ `uid` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —á—Ç–µ–Ω–∏–∏, –ª–∏–±–æ `error` –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ frontend

#### –£—Ä–æ–≤–µ–Ω—å 3: Svelte Store
```javascript
// src/stores/nfcReaderStore.js
import { writable } from 'svelte/store';

export const nfcReaderStore = writable({
    status: 'initializing', // 'initializing', 'ok', 'error'
    readerName: null,
    error: null
});
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:**
```svelte
<!-- src/components/modals/NFCModal.svelte -->
<script>
  import { listen } from '@tauri-apps/api/event';
  
  onMount(async () => {
    unlisten = await listen('card-status-changed', (event) => {
      if (event.payload.error) {
        status = 'error';
        errorMessage = event.payload.error;
      } else if (event.payload.uid) {
        status = 'success';
        cardUid = event.payload.uid;
        dispatch('uid-read', { uid: cardUid });
      }
    });
  });
</script>
```

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ NFC

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç `NfcReaderStatus.svelte` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—è:
- **üü¢ –ó–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä**: –°—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
- **üî¥ –ö—Ä–∞—Å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä**: –û—à–∏–±–∫–∞ —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—è —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ NFC

–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∏–¥–µ—Ä–∞**: `Error::NoReaders`
2. **–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞**: `Error::NoSmartcard`
3. **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –ü—Ä–æ–±–ª–µ–º—ã —Å PC/SC –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
4. **–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è UID**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç—ã

## 3. –ú–µ—Ö–∞–Ω–∏–∑–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ X-Internal-Token

–ö–ª–∞—Å—Å `SyncManager` —Ä–µ–∞–ª–∏–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é —Å backend –∏—Å–ø–æ–ª—å–∑—É—è –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

–í—Å–µ API –∑–∞–ø—Ä–æ—Å—ã –∫ backend –≤–∫–ª—é—á–∞—é—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Internal-Token`:

```python
headers = {"X-Internal-Token": INTERNAL_TOKEN}
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ config.py
```python
INTERNAL_TOKEN = os.getenv("INTERNAL_TOKEN", "demo-secret-key").strip()
```

### API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å —Ç–æ–∫–µ–Ω–æ–º

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –ú–µ—Ç–æ–¥ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω |
|----------|--------|------------|-----------------|
| `/api/system/status` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ | –î–∞ |
| `/api/sync/pours` | POST | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ª–∏–≤–æ–≤ | –î–∞ |
| `/api/guests` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã | –î–∞ |

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ sync_manager.py

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
```python
def check_emergency_stop(self):
    url = "/".join([self.server_url, "api", "system", "status"])
    headers = {"X-Internal-Token": INTERNAL_TOKEN}
    response = self.session.get(url, headers=headers, timeout=5)
    if response.status_code == 200:
        data = response.json()
        return str(data.get("value", "")).lower() == "true"
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
```python
def check_card_auth(self, card_uid):
    url = "/".join([self.server_url, "api", "guests"])
    headers = {"X-Internal-Token": INTERNAL_TOKEN}
    response = self.session.get(url, headers=headers, timeout=5)
    if response.status_code == 200:
        guests = response.json()
        for guest in guests:
            cards = guest.get("cards", [])
            if any(card.get("card_uid", "").replace(" ", "").lower() == clean_uid for card in cards):
                return True
```

#### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```python
def sync_cycle(self, db_handler):
    payload = {"pours": [dict(row) for row in pours]}
    url = "/".join([self.server_url, "api", "sync", "pours"])
    headers = {"X-Internal-Token": INTERNAL_TOKEN}
    response = self.session.post(url, json=payload, headers=headers, timeout=10)
```

### –°–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–≤ production –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω)
- –í—Å—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ backend –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤

## 4. –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ —Å gpiozero –∏ LGPIOFactory

–ö–ª–∞—Å—Å `HardwareHandler` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å gpiozero

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LGPIOFactory
```python
from gpiozero.pins.lgpio import LGPIOFactory
from gpiozero import Device

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ LGPIOFactory –¥–ª—è gpiozero
Device.pin_factory = LGPIOFactory()
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
```python
from gpiozero import DigitalInputDevice, OutputDevice

class HardwareHandler:
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ª–µ –∏ –¥–∞—Ç—á–∏–∫–∞ –ø–æ—Ç–æ–∫–∞
        self.relay = OutputDevice(PIN_RELAY)           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–ø–∞–Ω–æ–º
        self.flow_sensor = DigitalInputDevice(PIN_FLOW_SENSOR)  # –î–∞—Ç—á–∏–∫ –ø–æ—Ç–æ–∫–∞
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ –ø–æ—Ç–æ–∫–∞
        self.flow_sensor.when_activated = self._pulse_detected
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ LGPIOFactory –Ω–∞–¥ —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | LGPIOFactory | RPi.GPIO (—É—Å—Ç–∞—Ä–µ–ª) |
|----------------|-------------|-------------------|
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | Raspberry Pi 4/5 | –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ—Ç–æ–∫–æ–≤ | –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è | –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ê–∫—Ç–∏–≤–Ω–∞—è | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è |

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å pyscard –¥–ª—è NFC

#### –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
```python
from smartcard.System import readers

def is_card_present(self):
    r = readers()
    if not r:
        return False
    connection = r[0].createConnection()
    try:
        connection.connect()
        return True
    except Exception:
        return False
```

#### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ UID
```python
from smartcard.util import toHexString

def get_card_uid(self):
    r = readers()
    if not r:
        return None
    connection = r[0].createConnection()
    try:
        connection.connect()
        apdu = [0xFF, 0xCA, 0x00, 0x00, 0x00]  # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è UID
        response, sw1, sw2 = connection.transmit(apdu)
        if sw1 == 0x90 and sw2 == 0x00:
            return toHexString(response)
    except Exception:
        pass
    return None
```

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã HardwareHandler

```python
def valve_open() / valve_close()    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ª–µ –∫–ª–∞–ø–∞–Ω–∞
def get_volume_liters()             # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–º–ø—É–ª—å—Å–æ–≤ –≤ –æ–±—ä–µ–º
def is_card_present()               # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ NFC –∫–∞—Ä—Ç—ã
def get_card_uid()                  # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ UID –∫–∞—Ä—Ç—ã
def reset_pulses()                  # –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –∏–º–ø—É–ª—å—Å–æ–≤
```

### –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞ –ø–æ—Ç–æ–∫–∞
```python
def get_volume_liters(self):
    with self.lock:
        pulses = self.pulse_count
        self.pulse_count = 0
    # –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞ –≤ –ª–∏—Ç—Ä–∞—Ö
    return (pulses / FLOW_SENSOR_K_FACTOR) / 1000
```
–ì–¥–µ `FLOW_SENSOR_K_FACTOR = 7.5` –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ YF-S201.

### –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```python
from threading import Lock

def _pulse_detected(self):
    with self.lock:
        self.pulse_count += 1
```
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∏–º–ø—É–ª—å—Å–∞–º–∏ –∑–∞—â–∏—â–µ–Ω—ã `threading.Lock()` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ.

## 5. –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ setup.sh

–°–∫—Ä–∏–ø—Ç `setup.sh` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–∏—Å—Ç–µ–º—ã –Ω–∞ Raspberry Pi.

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
```bash
sudo apt-get update
sudo apt-get install -y \
    pcscd \
    libccid \
    python3-pyscard \
    python3-gpiozero \
    python3-lgpio \
    build-essential \
    swig \
    libpcsclite-dev \
    pkg-config
```

#### –ö–ª—é—á–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **pcscd**: PC/SC Smart Card daemon –¥–ª—è NFC —Ä–∏–¥–µ—Ä–æ–≤
- **libccid**: USB Chip/Smart Card Interface Devices –¥—Ä–∞–π–≤–µ—Ä
- **python3-pyscard**: Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–º–∞—Ä—Ç-–∫–∞—Ä—Ç–∞–º–∏
- **python3-gpiozero**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è GPIO
- **python3-lgpio**: Low-level GPIO –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è LGPIOFactory
- **build-essential/swig**: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –∏ –≥—Ä—É–ø–ø
```bash
sudo usermod -aG plugdev $USER    # –î–æ—Å—Ç—É–ø –∫ USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
sudo usermod -aG lp $USER         # –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º (NFC —Ä–∏–¥–µ—Ä—ã)
sudo usermod -aG gpio $USER       # –î–æ—Å—Ç—É–ø –∫ GPIO –ø–∏–Ω–∞–º
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Polkit –¥–ª—è pcscd
–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ NFC —Ä–∏–¥–µ—Ä–∞–º –±–µ–∑ –ø—Ä–∞–≤ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```bash
cat <<EOF | sudo tee /etc/polkit-1/rules.d/45-pcscd.rules
polkit.addRule(function(action, subject) {
    if ((action.id == "org.debian.pcsc-lite.access_pcsc" || 
         action.id == "org.debian.pcsc-lite.access_card") &&
        subject.isInGroup("plugdev")) {
        return polkit.Result.YES;
    }
});
EOF
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–±
```bash
sudo systemctl enable pcscd && sudo systemctl start pcscd
```
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è PC/SC –¥–µ–º–æ–Ω–∞ –¥–ª—è NFC —Ä–∏–¥–µ—Ä–æ–≤.

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
python3 -m venv --system-site-packages venv
source venv/bin/activate
pip install gpiozero pyscard requests
```

#### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ `--system-site-packages`:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (python3-pyscard, python3-gpiozero)
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requests)
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ NFC

### –®–∞–≥ 6: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
```bash
sudo chown -R $USER:$USER .
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É: sudo reboot"
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è:
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞
- –ê–∫—Ç–∏–≤–∞—Ü–∏–∏ Polkit –ø—Ä–∞–≤–∏–ª
- –ó–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–ª—É–∂–± –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

## 6. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ö–ª—é—á–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ `config.py`:

```python
# –°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SERVER_URL = "http://192.168.0.106:8000"  # –≠–Ω–¥–ø–æ–∏–Ω—Ç backend
INTERNAL_TOKEN = "demo-secret-key"        # –¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫—Ä–∞–Ω–∞
TAP_ID = 1                                # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫—Ä–∞–Ω–∞

# –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
PRICE_PER_100ML_CENTS = 150               # –¶–µ–Ω–∞ –∑–∞ 100–º–ª –≤ –∫–æ–ø–µ–π–∫–∞—Ö

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
SYNC_INTERVAL_SECONDS = 15                # –ß–∞—Å—Ç–æ—Ç–∞ —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

# –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø–∏–Ω—ã
PIN_RELAY = 18                            # GPIO –ø–∏–Ω –¥–ª—è —Ä–µ–ª–µ –∫–ª–∞–ø–∞–Ω–∞
PIN_FLOW_SENSOR = 17                      # GPIO –ø–∏–Ω –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ –ø–æ—Ç–æ–∫–∞

# –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–∞—Ç—á–∏–∫–∞
FLOW_SENSOR_K_FACTOR = 7.5                # K-—Ñ–∞–∫—Ç–æ—Ä –¥–ª—è YF-S201
```

## 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

### –°–µ—Ç–µ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –≤–∫–ª—é—á–∞—é—Ç —Ç–∞–π–º–∞—É—Ç—ã (5-10 —Å–µ–∫—É–Ω–¥)
- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
- –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ—è—Ö

### –ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –≤–æ –≤—Ä–µ–º—è –Ω–∞–ª–∏–≤–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–ø–∞–Ω–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
- –¢–∞–π–º–∞—É—Ç –¥–∞—Ç—á–∏–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –Ω–∞–ª–∏–≤

### –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

## 8. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫

1. **–ó–∞–ø—É—Å–∫**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
2. **–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª**: –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –≤—ã–∑–æ–≤ `flow_manager.process()`
3. **–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `sync_manager.sync_cycle()`
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∞–≤—Ç–æ–Ω–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
