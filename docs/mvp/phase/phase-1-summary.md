# Feature Reference & Implementation Summary
**Phase 1: Фундамент и управление гостями**
*Дата завершения: 2025-10-17*

## 1. Краткое описание Фазы 1

**Цель:** Заложить архитектурный фундамент десктопного Admin App и реализовать полный CRUD-цикл (Create, Read) для основной сущности системы — **Гостя**.

Эта фаза была критически важна для проверки и отладки всей технологической цепочки: от взаимодействия с пользователем в UI (Svelte) через мост с нативным кодом (Tauri/Rust) до аутентифицированного обмена данными с бэкендом (FastAPI).

**Контекст в дорожной карте:** Эта фаза является выполнением **Шагов 1.1, 1.2 и 1.3** из **Этапа 3** глобальной дорожной карты проекта.

## 2. Реализованные фичи

| # | Фича | Описание | Ключевые компоненты |
|---|---|---|---|
| **1.1** | **Аутентификация пользователя** | Реализован интерфейс входа. Приложение получает и безопасно хранит JWT-токен, который используется для всех последующих запросов к API. | `Login.svelte`, `sessionStore.js`, `login` (Tauri Command) |
| **1.2** | **Просмотр списка гостей** | Основной экран модуля отображает список всех гостей из базы данных. Данные запрашиваются при первом открытии страницы и кэшируются. | `Guests.svelte`, `GuestList.svelte`, `guestStore.js`, `get_guests` (Tauri Command) |
| **1.3** | **Поиск/фильтрация гостей** | Реализован мгновенный поиск по списку гостей на стороне клиента. Фильтрация происходит по ФИО без задержек и дополнительных запросов к API. | `GuestSearch.svelte`, реактивный блок `$` в `Guests.svelte` |
| **1.4** | **Детальный просмотр гостя** | При выборе гостя из списка справа открывается панель с полной информацией о нём, включая персональные данные, баланс, статус и список привязанных карт. | `GuestDetail.svelte`, `GuestListItem.svelte` (событие `on:select`) |
| **1.5** | **Создание нового гостя** | Реализовано модальное окно с формой для добавления нового гостя. Форма включает все обязательные поля. После успешного создания список обновляется мгновенно. | `GuestForm.svelte`, `Modal.svelte`, `create_guest` (Tauri Command) |

## 3. Изменения в структуре проекта

В ходе фазы архитектура фронтенд-приложения была формализована и расширена.

*   **Новые директории:**
    *   `src/stores/`: Для централизованного управления состоянием (`sessionStore.js`, `guestStore.js`).
    *   `src/components/common/`: Для общих, переиспользуемых UI-компонентов (`Modal.svelte`).
    *   `src/components/guests/`: Для компонентов, специфичных для модуля управления гостями.

*   **Ключевые новые/измененные файлы:**
    *   `src-tauri/src/api_client.rs`: **Новый** Rust-модуль, инкапсулирующий всю логику взаимодействия с FastAPI.
    *   `src-tauri/src/main.rs`: Расширен новыми Tauri-командами.
    *   `src/routes/Guests.svelte`: Переработан в "умный" компонент-контейнер, управляющий состоянием и дочерними компонентами.
    *   `src/App.svelte`: Упрощен, теперь отвечает только за маршрутизацию на основе статуса аутентификации.

## 4. Архитектурные решения

### API-слой (Tauri/Rust)

*   **Tauri-команды:** Вся коммуникация между Svelte и Rust осуществляется через асинхронные Tauri-команды. Были добавлены:
    *   `login(username, password) -> Result<String, AppError>`
    *   `get_guests(token) -> Result<Vec<Guest>, AppError>`
    *   `create_guest(token, guest_data) -> Result<Guest, AppError>`
*   **Rust API Client (`api_client.rs`):** Вся логика HTTP-запросов вынесена из команд в отдельный модуль. Это обеспечивает:
    *   **Типобезопасность:** Rust-структуры (`Guest`, `Card`, `GuestPayload`) точно соответствуют Pydantic-схемам FastAPI, что гарантирует корректный парсинг данных.
    *   **Производительность:** Используется единый, глобальный `reqwest::Client` с пулом соединений.
    *   **Централизованная обработка ошибок:** Все ответы API проходят через единую функцию `handle_api_error`.

### Frontend-архитектура (Svelte)

*   **Svelte Stores:** Принято решение использовать `writable` сторы для управления глобальным состоянием:
    *   `sessionStore`: Хранит JWT-токен и управляет состоянием аутентификации.
    *   `guestStore`: Кэширует список гостей, управляет состоянием загрузки и ошибками, инкапсулирует вызовы `invoke`.
*   **Компонентный паттерн "Container/Presentational":**
    *   **Контейнер (`Guests.svelte`):** "Умный" компонент, который подписывается на сторы, управляет локальным состоянием (поиск, выбор) и передает данные дочерним компонентам через `props`.
    *   **Презентационные компоненты (`GuestList`, `GuestDetail` и др.):** "Глупые" компоненты, которые только отображают полученные `props` и сообщают о действиях пользователя наверх через события (`on:select`, `on:save`).

## 5. Взаимодействие с бэкендом (FastAPI)

| Эндпоинт | Метод | Статус | Примечание |
|---|---|---|---|
| `/api/token` | `POST` | ✅ **Реализовано и используется** | Основной эндпоинт для аутентификации. |
| `/api/guests/` | `GET` | ✅ **Реализовано и используется** | Получение списка гостей. |
| `/api/guests/` | `POST` | ✅ **Реализовано и используется** | Создание нового гостя. |
| `/api/guests/{guest_id}` | `GET` | ❌ **Не используется** | Пока нет UI для запроса одного гостя. `GuestDetail` работает с кэшем. |
| `/api/guests/{guest_id}` | `PUT` / `PATCH` | ⛔ **Отсутствует на бэкенде** | **Ключевое ограничение.** Функционал редактирования гостя не может быть реализован. |

## 6. Отклонения от первоначального плана

*   **Итеративная отладка API-контракта:** Изначальный план предполагал наличие готового API. На практике была проведена значительная работа по синхронизации DTO в Rust и Pydantic-схем в Python. Этот процесс выявил несоответствия в типах данных (UUID vs Int), именах полей (`id` vs `guest_id`) и структуре ответов (прямой массив vs обертка `ApiResponse`), которые были успешно устранены.
*   **Реализация только "Create":** Из-за отсутствия эндпоинта для обновления гостя, Шаг 1.3 был реализован частично (только создание).

## 7. Рекомендации для Фазы 2

1.  **Backend:** Приоритетной задачей для разблокировки UI-разработки является реализация эндпоинта `PUT /api/guests/{guest_id}` для обновления данных гостя.
2.  **Frontend:** Реализовать UI для редактирования гостя, переиспользовав компонент `GuestForm.svelte` в режиме редактирования.
3.  **Архитектура:** Рассмотреть возможность вынесения логики форматирования (даты, валюты) в отдельные утилитарные функции (`src/lib/formatters.js`) для переиспользования в разных компонентах.

---
---

## Дополнительные отчёты

### API Coverage Report (Модуль Guests)

| Эндпоинт | Метод | Покрытие клиентом | Примечание |
|---|---|---|---|
| `/api/guests/` | `POST` | ✅ **Полное** | Используется для создания гостя. |
| `/api/guests/` | `GET` | ✅ **Полное** | Используется для получения списка гостей. |
| `/api/guests/{guest_id}` | `GET` | ❌ **Нет** | Функционал не требуется на данном этапе. |
| `/api/guests/{guest_id}/cards` | `POST` | ❌ **Нет** | Будет реализовано в Фазе 2 (NFC). |
| `/api/guests/{guest_id}/cards/{card_uid}` | `DELETE` | ❌ **Нет** | Будет реализовано в Фазе 2 (NFC). |
| `/api/guests/{guest_id}/topup` | `POST` | ❌ **Нет** | Будет реализовано в Фазе 2 (Транзакции). |
| `/api/guests/{guest_id}/history` | `GET` | ❌ **Нет** | Будет реализовано в будущих фазах (Отчетность). |

### File-Level Change Summary (Phase 1)

| Файл | Статус | Краткое описание изменений |
|---|---|---|
| `src-tauri/src/api_client.rs` | **Новый** | Инкапсулирует всю логику HTTP-запросов. Содержит Rust-модели данных, точно соответствующие API. |
| `src-tauri/src/main.rs` | **Изменен** | Добавлены и зарегистрированы Tauri-команды `login`, `get_guests`, `create_guest`. |
| `src/stores/sessionStore.js` | **Новый** | Управляет JWT-токеном и состоянием аутентификации. |
| `src/stores/guestStore.js` | **Новый** | Управляет состоянием (данные, загрузка, ошибки) для сущности "Гость". |
| `src/routes/Guests.svelte` | **Изменен** | Переработан в компонент-контейнер. Управляет дочерними компонентами и модальным окном. |
| `src/components/common/Modal.svelte` | **Новый** | Универсальный компонент для модальных окон. |
| `src/components/guests/*` | **Новые** | Созданы все компоненты для UI модуля: `GuestSearch`, `GuestList`, `GuestListItem`, `GuestDetail`, `GuestForm`. |

### Technical Insight Report

1.  **Выбор Rust для API-слоя оправдал себя:** Несмотря на начальные сложности с отладкой типов и `Deserialize`, использование Rust для общения с API дало нам строгую типизацию "от края до края". Ошибки несоответствия форматов данных теперь обнаруживаются на этапе компиляции или в виде четких сообщений об ошибках парсинга, а не как `undefined is not a function` в JavaScript.
2.  **Централизованное управление состоянием (Stores) — ключ к масштабированию:** Вынос логики запросов и кэширования в `guestStore` уже окупился. Компоненты UI остались простыми, а логика загрузки и обновления данных не дублируется. Этот паттерн будет легко расширить для новых сущностей (Кеги, Краны).
3.  **"Источник правды" в `schemas.py`:** Итеративный процесс отладки показал, что ручная синхронизация моделей данных между frontend и backend подвержена ошибкам. `schemas.py` стал де-факто контрактом, на который мы опирались для исправления Rust-структур. В будущем можно рассмотреть инструменты для автоматической генерации DTO на основе OpenAPI-спецификации.

### Next Steps Checklist (для Фазы 2)

| Категория | Задача | Статус |
|---|---|---|
| **Бэкенд** | Реализовать эндпоинт `PUT /api/guests/{guest_id}` для обновления данных гостя. | Blocked |
| **Frontend** | Реализовать UI для режима редактирования в `GuestForm.svelte`. | ⬜ To Do |
| **Frontend** | Добавить кнопку "Edit" в `GuestDetail.svelte`, которая будет открывать модальное окно с формой. | ⬜ To Do |
| **Планирование** | Провести scoping-сессию для **Фазы 2: "NFC и Транзакции"**, определить необходимые API-эндпоинты и UI-компоненты. | ⬜ To Do |